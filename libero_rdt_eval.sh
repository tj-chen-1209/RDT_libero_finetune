#!/bin/bash
# ============================================================================
# RDT-LIBERO 统一评估脚本 (配置文件驱动)
# ============================================================================
# 使用方法:
#   1. 编辑配置文件: libero_eval/config/eval_config.yaml
#   2. 运行此脚本: ./eval_all_tasks_fast.sh
#
# 或指定其他配置文件:
#   ./eval_all_tasks_fast.sh path/to/your/config.yaml
# ============================================================================

set -e

# ============================================================================
# 环境设置
# ============================================================================
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "${SCRIPT_DIR}"

source /share_data/zhukefei/miniconda3/etc/profile.d/conda.sh
conda activate rdt_libero_eval

# a============================================================================
# 配置文件解析
# ============================================================================

# 默认配置文件
DEFAULT_CONFIG="libero_eval/config/eval_config.yaml"

# 如果提供了参数，使用参数指定的配置文件；否则使用默认配置
if [ $# -ge 1 ]; then
    CONFIG_FILE="$1"
else
    CONFIG_FILE="${DEFAULT_CONFIG}"
fi

# 验证配置文件是否存在
if [ ! -f "${CONFIG_FILE}" ]; then
    echo "╔══════════════════════════════════════════════════════════════════════════╗"
    echo "║                          ❌ 配置文件不存在                               ║"
    echo "╚══════════════════════════════════════════════════════════════════════════╝"
    echo ""
    echo "指定的配置文件: ${CONFIG_FILE}"
    echo ""
    if [ "${CONFIG_FILE}" == "${DEFAULT_CONFIG}" ]; then
        echo "默认配置文件不存在，请先创建:"
        echo "  1. 创建目录: mkdir -p libero_eval/config"
        echo "  2. 复制模板: cp eval_config_template.yaml ${DEFAULT_CONFIG}"
        echo "  3. 编辑配置: vim ${DEFAULT_CONFIG}"
    else
        echo "请检查文件路径是否正确"
    fi
    echo ""
    echo "════════════════════════════════════════════════════════════════════════════"
    exit 1
fi

# 验证配置文件格式
if [[ ! "${CONFIG_FILE}" == *.yaml ]] && [[ ! "${CONFIG_FILE}" == *.yml ]]; then
    echo "╔══════════════════════════════════════════════════════════════════════════╗"
    echo "║                     ❌ 配置文件格式错误                                  ║"
    echo "╚══════════════════════════════════════════════════════════════════════════╝"
    echo ""
    echo "配置文件必须是 YAML 格式 (.yaml 或 .yml)"
    echo "当前文件: ${CONFIG_FILE}"
    echo ""
    echo "════════════════════════════════════════════════════════════════════════════"
    exit 1
fi

# ============================================================================
# 显示配置信息
# ============================================================================

echo ""
echo "╔══════════════════════════════════════════════════════════════════════════╗"
echo "║                       RDT-LIBERO 批量评估系统                           ║"
echo "╚══════════════════════════════════════════════════════════════════════════╝"
echo ""
echo "📄 配置文件: ${CONFIG_FILE}"
echo "📂 工作目录: ${SCRIPT_DIR}"
echo "🐍 Conda环境: rdt_libero_eval"
echo ""
echo "────────────────────────────────────────────────────────────────────────────"
echo "📋 当前配置:"
echo "────────────────────────────────────────────────────────────────────────────"

# 显示配置文件内容 (去除注释和空行)
grep -v "^#" "${CONFIG_FILE}" | grep -v "^$" | sed 's/^/  /' || true

echo "────────────────────────────────────────────────────────────────────────────"
echo ""

# ============================================================================
# 开始评估
# ============================================================================

START_TIME=$(date +%s)
START_TIME_READABLE=$(date "+%Y-%m-%d %H:%M:%S")

echo "⏰ 开始时间: ${START_TIME_READABLE}"
echo ""
echo "════════════════════════════════════════════════════════════════════════════"
echo "🚀 正在启动评估..."
echo "════════════════════════════════════════════════════════════════════════════"
echo ""

# 从配置文件中读取 GPU 设置
GPU_ID=$(grep -E "^\s*gpu:" "${CONFIG_FILE}" | sed 's/.*gpu:\s*//' | sed 's/#.*//' | tr -d ' ')
if [ -z "$GPU_ID" ]; then
    GPU_ID=0  # 默认使用 GPU 0
fi

echo "🔧 设置 CUDA_VISIBLE_DEVICES=${GPU_ID}"
echo ""

# 设置环境变量并调用 Python 评估脚本
export CUDA_VISIBLE_DEVICES=${GPU_ID}
python libero_eval/libero_rdt_eval.py --config "${CONFIG_FILE}"

EXIT_CODE=$?

# ============================================================================
# 评估结束
# ============================================================================

END_TIME=$(date +%s)
END_TIME_READABLE=$(date "+%Y-%m-%d %H:%M:%S")
ELAPSED_TIME=$((END_TIME - START_TIME))
ELAPSED_MINUTES=$((ELAPSED_TIME / 60))
ELAPSED_SECONDS=$((ELAPSED_TIME % 60))

echo ""

if [ ${EXIT_CODE} -eq 0 ]; then
    echo "╔══════════════════════════════════════════════════════════════════════════╗"
    echo "║                            ✅ 评估成功完成！                             ║"
    echo "╚══════════════════════════════════════════════════════════════════════════╝"
else
    echo "╔══════════════════════════════════════════════════════════════════════════╗"
    echo "║                            ❌ 评估过程出错                               ║"
    echo "╚══════════════════════════════════════════════════════════════════════════╝"
fi

echo ""
echo "📊 配置文件: ${CONFIG_FILE}"
echo "⏰ 开始时间: ${START_TIME_READABLE}"
echo "⏰ 结束时间: ${END_TIME_READABLE}"
echo "⏱  总耗时: ${ELAPSED_MINUTES} 分 ${ELAPSED_SECONDS} 秒"
echo ""

if [ ${EXIT_CODE} -eq 0 ]; then
    echo "💡 下一步:"
    echo "  - 查看 outs/metrics/ 目录中的 CSV 文件获取详细结果"
    echo "  - 如需调整评估参数，请编辑: ${CONFIG_FILE}"
    echo "  - 如需评估其他数据集，修改配置文件中的 dataset.name"
else
    echo "💡 故障排查:"
    echo "  - 检查配置文件中的路径是否正确"
    echo "  - 确认 checkpoint 文件存在"
    echo "  - 查看上方错误信息"
fi

echo ""
echo "════════════════════════════════════════════════════════════════════════════"

exit ${EXIT_CODE}
